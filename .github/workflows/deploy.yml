name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

env:
  BACKEND_PATH: /var/www/video-speed
  FRONTEND_PATH: /var/www/video-speed/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ""
          oauth-secret: ""
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:ci

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_TS_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Backend
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_TS_IP }} << 'ENDSSH'
          cd /var/www/video-speed
          
          # Pull latest code
          git fetch origin
          git reset --hard origin/main
          
          # Copy backend app.py to root (Gunicorn config)
          cp backend/app.py app.py
          
          # Install dependencies if requirements changed
          /var/www/video-speed/venv/bin/pip install -r backend/requirements.txt --quiet
          
          # Restart backend service
          systemctl restart video-speed-backend
          
          echo "âœ… Backend deployed!"
          ENDSSH

      - name: Deploy Frontend
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_TS_IP }} << 'ENDSSH'
          cd /var/www/video-speed/frontend
          
          # Pull latest code  
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          npm ci --silent
          
          # Clean build
          rm -rf .next
          npm run build
          
          # Restart frontend service
          systemctl restart video-speed-frontend
          
          echo "âœ… Frontend deployed!"
          ENDSSH

      - name: Verify Deployment
        run: |
          sleep 10
          curl -sf https://video-speed.34.142.180.166.nip.io/health || echo "âš ï¸ Backend health check failed"
          curl -sf https://video-speed.34.142.180.166.nip.io/ || echo "âš ï¸ Frontend check failed"
          echo "ðŸŽ‰ Deployment complete!"
