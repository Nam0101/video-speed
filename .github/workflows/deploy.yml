name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Cho ph√©p trigger th·ªß c√¥ng

env:
  BACKEND_PATH: /var/www/video-speed
  FRONTEND_PATH: /root/video-speed/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ""
          oauth-secret: ""
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:ci

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_TS_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Backend
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_TS_IP }} << 'ENDSSH'
          cd /var/www/video-speed
          
          # Pull latest code
          git fetch origin
          git reset --hard origin/main
          
          # Copy backend app.py to root (Gunicorn config)
          cp backend/app.py app.py
          
          # Install dependencies if requirements changed
          /var/www/video-speed/venv/bin/pip install -r backend/requirements.txt --quiet
          
          # Graceful reload Gunicorn workers
          pkill -HUP gunicorn || echo "Gunicorn not running, starting..."
          
          # Verify Gunicorn is running
          pgrep -f gunicorn || {
            source venv/bin/activate
            nohup gunicorn -w 4 -b 0.0.0.0:5000 app:app > /var/log/gunicorn.log 2>&1 &
          }
          
          echo "‚úÖ Backend deployed!"
          ENDSSH

      - name: Deploy Frontend
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_TS_IP }} << 'ENDSSH'
          cd /root/video-speed/frontend
          
          # Pull latest code  
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          npm ci --silent
          
          # Clean build
          rm -rf .next
          npm run build
          
          # Restart Next.js server
          pkill -9 -f 'next-server' || true
          nohup npm run start -- -p 3002 > /var/log/frontend.log 2>&1 &
          
          echo "‚úÖ Frontend deployed!"
          ENDSSH

      - name: Verify Deployment
        run: |
          sleep 5
          curl -sf https://video-speed.160.250.136.70.nip.io/health || echo "‚ö†Ô∏è Backend health check failed"
          curl -sf https://video-speed.160.250.136.70.nip.io/ || echo "‚ö†Ô∏è Frontend check failed"
          echo "üéâ Deployment complete!"
